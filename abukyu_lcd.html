<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>阿武急車内案内表示器 (阪急風)</title>
    <style>
      /* ===== 言語表示切替（最優先） ===== */
      [data-lang="kanji"] .kanji {
        display: inline-block !important;
      }
      [data-lang="kana"] .kana {
        display: inline-block !important;
      }
      [data-lang="en"] .en {
        display: inline-block !important;
      }

      /* 既定は非表示（次点優先） */
      .kanji,
      .kana,
      .en {
        display: none !important;
      }

      /* ===== 共通 ===== */
      html,
      body {
        margin: 0;
        padding: 0;
        aspect-ratio: 32/9;
        overflow: hidden;
      }
      header {
        height: 6vw;
      }
      main {
        height: 100%;
      }

      /* 下段帯 */
      .header-bottom {
        position: fixed;
        z-index: 1;
        top: 0;
        left: 0;
        display: flex;
        justify-content: flex-end;
        align-items: center;
        width: 100%;
        height: 6vw;
        background: #266cb4;
        color: #fff;
      }

      /* 上段（影用ラッパ） */
      .header-top-shadow {
        position: relative;
        z-index: 2;
        filter: drop-shadow(5px 5px 5px rgba(0, 0, 0, 0.4));
      }

      .header-top {
        position: fixed;
        top: 0;
        left: 0;
        display: flex;
        align-items: center;
        gap: 1vw;
        width: 100%;
        height: 6vw;
        color: #fff;
        background: linear-gradient(180deg, #3e98ee, #2573c6);
        clip-path: polygon(
          0 0,
          calc(100% - 48vw) 0,
          calc(100% - 44vw) 5.5vw,
          100% 5.5vw,
          100% 100%,
          0 100%
        );
      }
      .header-top::before {
        content: "";
        position: absolute;
        left: 0;
        right: 0;
        top: 5.75vw;
        height: 0.25vw;
        background: #70a5cf; /* 6vw - 5.75vw */
      }

      /* 種別 */
      .train-type-box {
        width: 19.5vw;
        padding-block: 2px;
        line-height: 1;
        background: #333;
        border-radius: 0 1vw 1vw 0;
        box-shadow: inset 0 2px 0 0 #fff, inset -2px 0 0 0 #fff,
          inset 0 -2px 0 0 #fff;
        display: flex;
        justify-content: center;
        align-items: center;
      }
      .train-type {
        text-align: center;
        font-size: 3.75vw;
        font-weight: 700;
        color: #fff;
      }

      /* 行先 */
      .dest {
        display: flex;
        gap: 1vw;
        align-items: baseline;
        font-size: 3.75vw;
        font-weight: 800;
      }
      .dest small {
        font-size: 2.5vw;
        opacity: 0.95;
      }

      /* 次駅表示 */
      .header-next {
        display: flex;
        justify-content: flex-end;
        align-items: baseline;
      }
      .next-left,
      .next-right {
        padding: 0 0.5vw;
        font-size: 2.5vw;
        font-weight: 800;
      }
      .next-right {
        width: 6vw;
      }
      .next-box {
        width: 25.75vw;
        border-radius: 1vw;
        background: #fff;
        box-shadow: 0 0 1px 1px #fff;
        display: flex;
        justify-content: center;
        align-items: center;
      }
      .next-name {
        padding-block: 2px;
        line-height: 1;
        font-size: 3.75vw;
        font-weight: 800;
        color: #1f2740;
        white-space: nowrap;
      }

      /* 路線 */
      .line-panel {
        height: 100%;
        background: #deecf9;
      }
      .line {
        position: absolute;
        left: 4.5vw;
        right: 4.5vw;
        bottom: calc(100% - 22.5vw);
        display: flex;
        justify-content: space-between;
        height: 2vw;
        background: linear-gradient(#8fc3e4, #3b78b4);
        border-radius: 1vw;
      }
      .station {
        position: relative;
        width: 2vw;
        height: 2vw;
        background: #fff;
        border-radius: 1vw;
        box-shadow: inset 0 0 0 2px #333;
      }

      /* 駅名のベース位置 */
      .name.kanji,
      .name.kana {
        position: absolute;
        bottom: 100%;
        left: 50%;
        transform: translateX(-50%);
        white-space: nowrap;
      }
      .name.en {
        position: absolute;
        bottom: 100%;
        left: 100%;
        white-space: nowrap;
      }

      /* 駅名の見た目（中身） */
      .name-inner {
        font-weight: 700;
        color: #111;
        line-height: 1;
        white-space: nowrap;
      }
      .name-inner.kanji {
        writing-mode: vertical-rl;
        font-size: 2.25vw;
      }
      .name-inner.kana {
        writing-mode: vertical-rl;
        font-size: 2vw;
      }
      .name-inner.en {
        display: inline-block;
        font-size: 2vw;
        transform-origin: bottom left;
        transform: rotate(-75deg);
      }
    </style>
  </head>
  <body>
    <header>
      <div class="header-bottom">
        <div class="header-next">
          <div>
            <div class="next-left kanji">つぎは</div>
            <div class="next-left kana">つぎは</div>
            <div class="next-left en">Next</div>
          </div>
          <div class="next-box">
            <span class="next-name kanji" id="next-name-kanji"></span>
            <span class="next-name kana" id="next-name-kana"></span>
            <span class="next-name en" id="next-name-en"></span>
          </div>
          <div>
            <div class="next-right kanji">です</div>
            <div class="next-right kana">です</div>
            <div class="next-right en"></div>
          </div>
        </div>
      </div>

      <div class="header-top-shadow">
        <div class="header-top">
          <div class="train-type-box">
            <div class="train-type kanji" id="train-type-kanji"></div>
            <div class="train-type kana" id="train-type-kana"></div>
            <div class="train-type en" id="train-type-en"></div>
          </div>
          <div class="dest">
            <small class="en">For</small>
            <span class="kanji" id="dest-name-kanji"></span>
            <span class="kana" id="dest-name-kana"></span>
            <span class="en" id="dest-name-en"></span>
            <small class="kanji">ゆき</small>
            <small class="kana">ゆき</small>
          </div>
        </div>
      </div>
    </header>

    <main>
      <div class="line-panel" id="line-panel">
        <div class="line" id="line"></div>
      </div>
      <div class="settings-panel" id="settings-panel">
        <h2>設定</h2>
        <p>ここに各種設定項目を配置できます。</p>
      </div>
    </main>

    <script>
      /* ===================== データ ===================== */
      const data = {
        lineName: "阿武隈急行線",
        stations: [
          "福島",
          "卸町",
          "福島学院前",
          "瀬上",
          "向瀬上",
          "高子",
          "上保原",
          "保原",
          "大泉",
          "二井田",
          "新田",
          "梁川",
          "やながわ希望の森公園前",
          "富野",
          "兜",
          "あぶくま",
          "丸森",
          "北丸森",
          "南角田",
          "角田",
          "横倉",
          "岡",
          "東船岡",
          "槻木",
        ],
        kana: {
          "普　通": "ふつう",
          "快　速": "かいそく",
          "貸　切": "かしきり",
          福島: "ふくしま",
          卸町: "おろしまち",
          福島学院前: "ふくしまがくいんまえ",
          瀬上: "せのうえ",
          向瀬上: "むかいせのうえ",
          高子: "たかこ",
          上保原: "かみほばら",
          保原: "ほばら",
          大泉: "おおいずみ",
          二井田: "にいだ",
          新田: "にった",
          梁川: "やながわ",
          やながわ希望の森公園前: "やながわきぼうのもりこうえんまえ",
          富野: "とみの",
          兜: "かぶと",
          あぶくま: "あぶくま",
          丸森: "まるもり",
          北丸森: "きたまるもり",
          南角田: "みなみかくだ",
          角田: "かくだ",
          横倉: "よこくら",
          岡: "おか",
          東船岡: "ひがしふなおか",
          槻木: "つきのき",
        },
        en: {
          "普　通": "Local",
          "快　速": "Rapid",
          "貸　切": "Chartered",
          福島: "Fukushima",
          卸町: "Oroshimachi",
          福島学院前: "Fukushima Gakuin-mae",
          瀬上: "Senoue",
          向瀬上: "Mukaisenoue",
          高子: "Takako",
          上保原: "Kamihobara",
          保原: "Hobara",
          大泉: "Ōizumi",
          二井田: "Niida",
          新田: "Nitta",
          梁川: "Yanagawa",
          やながわ希望の森公園前: "Yanagawa Kibōnomori Kōen-mae",
          富野: "Tomino",
          兜: "Kabuto",
          あぶくま: "Abukuma",
          丸森: "Marumori",
          北丸森: "Kita-Marumori",
          南角田: "Minami-Kakuda",
          角田: "Kakuda",
          横倉: "Yokokura",
          岡: "Oka",
          東船岡: "Higashi-Funaoka",
          槻木: "Tsukinoki",
        },
      };

      const status = {
        trainType: "貸　切",
        origin: "福島",
        dest: "丸森",
        next: "梁川",
      };

      /* ===================== ヘルパ ===================== */
      const qs = (sel, root = document) => root.querySelector(sel);
      const qsa = (sel, root = document) => [...root.querySelectorAll(sel)];
      const vw = (v) => window.innerWidth * (v / 100);

      /** 任意軸で max を超えた分だけ縮小（transform 前置にも対応） */
      function scaleToFit(
        el,
        { maxPx, axis = "x", origin = "center", prefix = "" }
      ) {
        if (!el) return;
        // レイアウト確定後のサイズ取得
        const actual =
          axis.toLowerCase() === "y" ? el.offsetHeight : el.offsetWidth;

        if (actual > maxPx) {
          const scale = maxPx / actual;
          const scaleStr =
            axis.toLowerCase() === "y"
              ? `scaleY(${scale})`
              : `scaleX(${scale})`;
          el.style.transform = `${prefix}${prefix ? " " : ""}${scaleStr}`;
          el.style.transformOrigin = origin;
        } else {
          el.style.transform = prefix; // 既定の transform のみに戻す
          el.style.transformOrigin = origin;
        }
      }

      function setTexts(map) {
        for (const [id, text] of Object.entries(map)) {
          const el = document.getElementById(id);
          if (el) el.textContent = text ?? "";
        }
      }

      /* ===================== 初期テキスト反映 ===================== */
      setTexts({
        "train-type-kanji": status.trainType,
        "train-type-kana": data.kana[status.trainType],
        "train-type-en": data.en[status.trainType],
        "dest-name-kanji": status.dest,
        "dest-name-kana": data.kana[status.dest],
        "dest-name-en": data.en[status.dest],
        "next-name-kanji": status.next,
        "next-name-kana": data.kana[status.next],
        "next-name-en": data.en[status.next],
      });

      /* ===================== 駅DOM生成 ===================== */
      const lineEl = qs("#line");
      for (const name of data.stations) {
        const s = document.createElement("div");
        s.className = "station" + (name === status.next ? " next" : "");
        s.dataset.name = name;

        const mk = (cls, inner) => {
          const d = document.createElement("div");
          d.className = `name ${cls}`;
          d.innerHTML = `<span class="name-inner ${cls}">${inner}</span>`;
          return d;
        };
        s.appendChild(mk("kanji", name));
        s.appendChild(mk("kana", data.kana[name]));
        s.appendChild(mk("en", data.en[name]));
        lineEl.appendChild(s);
      }

      /* ===================== スケーリング ===================== */
      function applyScaling() {
        // 駅名（縦書きは高さを制限、英語は回転＋横幅を制限）
        qsa(".name-inner").forEach((el) => {
          if (el.classList.contains("en")) {
            // 既定回転を prefix に保持
            scaleToFit(el, {
              maxPx: vw(13),
              axis: "x",
              origin: "bottom left",
              prefix: "rotate(-75deg)",
            });
          } else {
            scaleToFit(el, {
              maxPx: vw(12.5),
              axis: "y",
              origin: "bottom center",
            });
          }
        });

        // 種別
        qsa(".train-type").forEach((el) => {
          scaleToFit(el, { maxPx: vw(18), axis: "x", origin: "center" });
        });

        // 行先（全体ブロックを縮める）
        qsa(".dest").forEach((el) => {
          scaleToFit(el, { maxPx: vw(32.5), axis: "x", origin: "left" });
        });

        // 次駅
        qsa(".next-name").forEach((el) => {
          scaleToFit(el, { maxPx: vw(25), axis: "x", origin: "center" });
        });
      }

      // レイアウトが変わる操作の直後に 1フレーム待って実行
      const rafApply = () => requestAnimationFrame(applyScaling);

      /* ===================== 言語切替 ===================== */
      const order = ["kanji", "kana", "en"];
      let idx = 0;
      document.documentElement.setAttribute("data-lang", order[idx]);
      rafApply();

      setInterval(() => {
        idx = (idx + 1) % order.length;
        document.documentElement.setAttribute("data-lang", order[idx]);
        rafApply();
      }, 5000);

      /* ===================== 設定画面表示切替 ===================== */
      const settings = document.getElementById("settings-panel");
      const lineView = document.getElementById("line-panel");
      document
        .querySelector(".train-type-box")
        .addEventListener("dblclick", () => {
          const showingSettings = settings.style.display === "block";
          settings.style.display = showingSettings ? "none" : "block";
          lineView.style.display = showingSettings ? "flex" : "none";
          rafApply();
        });

      /* ===================== リサイズ対応（軽量化） ===================== */
      let resizeTid = 0;
      window.addEventListener("resize", () => {
        clearTimeout(resizeTid);
        resizeTid = setTimeout(rafApply, 100); // 連打抑制
      });

      // DOM完成後の最終調整（フォントロード後の差異吸収）
      window.addEventListener("load", () => {
        rafApply();
        setTimeout(rafApply, 0); // もう1フレーム余裕を見る
      });
    </script>
  </body>
</html>
